<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>$CLAWD Token Verification</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      max-width: 420px;
      width: 100%;
      padding: 2rem;
      text-align: center;
    }
    .logo { font-size: 4rem; margin-bottom: 1rem; }
    h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: #ff6b6b; }
    .subtitle { color: #888; margin-bottom: 2rem; font-size: 0.9rem; }
    .btn {
      display: inline-block;
      padding: 14px 32px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: background 0.2s;
    }
    .btn:hover { background: #ff5252; }
    .btn:disabled { background: #444; cursor: not-allowed; }
    .status {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      display: none;
    }
    .status.error { display: block; background: #2d1515; color: #ff6b6b; border: 1px solid #ff6b6b33; }
    .status.success { display: block; background: #152d15; color: #6bff6b; border: 1px solid #6bff6b33; }
    .status.info { display: block; background: #15152d; color: #6b6bff; border: 1px solid #6b6bff33; }
    .step { margin-top: 1rem; color: #888; font-size: 0.85rem; }
    .address { font-family: monospace; font-size: 0.8rem; word-break: break-all; margin-top: 0.5rem; color: #aaa; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ðŸ¦ž</div>
    <h1>$CLAWD Token Gate</h1>
    <p class="subtitle">Connect your wallet and verify you hold at least 10M $CLAWD (~$500) on Base to join the chat</p>

    <button id="connectBtn" class="btn" onclick="connect()">Connect Wallet</button>

    <div id="status" class="status"></div>
    <div id="steps" class="step"></div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const telegramUserId = params.get('tg');
    const chatId = params.get('chat');

    if (!telegramUserId || !chatId) {
      showStatus('error', 'Missing verification parameters. Use the link from the Telegram bot.');
    }

    let provider = null;
    let signer = null;
    let address = null;

    function showStatus(type, msg) {
      const el = document.getElementById('status');
      el.className = 'status ' + type;
      el.textContent = msg;
    }

    function showStep(msg) {
      document.getElementById('steps').textContent = msg;
    }

    async function connect() {
      const btn = document.getElementById('connectBtn');

      if (!window.ethereum) {
        showStatus('error', 'No wallet detected. Install MetaMask or use a Web3 browser.');
        return;
      }

      try {
        btn.disabled = true;
        btn.textContent = 'Connecting...';
        showStep('Step 1/3: Connecting wallet...');

        // Request accounts
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        address = accounts[0];
        showStep('Step 2/3: Getting nonce...');

        // Get nonce from server
        const nonceRes = await fetch(`/api/nonce?tg=${telegramUserId}&chat=${chatId}`);
        const { nonce } = await nonceRes.json();

        // Build SIWE message
        const domain = window.location.host;
        const origin = window.location.origin;
        const statement = `Verify $CLAWD token ownership for Telegram user ${telegramUserId}`;

        const siweMessage = [
          `${domain} wants you to sign in with your Ethereum account:`,
          address,
          '',
          statement,
          '',
          `URI: ${origin}`,
          `Version: 1`,
          `Chain ID: 8453`,
          `Nonce: ${nonce}`,
          `Issued At: ${new Date().toISOString()}`,
        ].join('\n');

        showStep('Step 3/3: Sign the message in your wallet...');

        // Request signature
        const signature = await window.ethereum.request({
          method: 'personal_sign',
          params: [siweMessage, address],
        });

        showStep('Verifying...');

        // Send to server
        const verifyRes = await fetch('/api/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: siweMessage, signature }),
        });

        const result = await verifyRes.json();

        if (result.success) {
          showStatus('success', 'âœ… Verified! Check your Telegram DMs from @ClawdBouncerBot â€” your invite link is there! ðŸ¦ž');
          btn.textContent = 'Verified âœ…';
          showStep('');
        } else {
          showStatus('error', result.error || 'Verification failed');
          btn.disabled = false;
          btn.textContent = 'Try Again';
          showStep('');
        }
      } catch (err) {
        console.error(err);
        showStatus('error', err.message || 'Something went wrong');
        btn.disabled = false;
        btn.textContent = 'Try Again';
        showStep('');
      }
    }
  </script>
</body>
</html>
