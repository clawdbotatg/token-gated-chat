<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>$CLAWD Token Verification</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      max-width: 420px;
      width: 100%;
      padding: 2rem;
      text-align: center;
    }
    .logo { font-size: 4rem; margin-bottom: 1rem; }
    h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: #ff6b6b; }
    .subtitle { color: #888; margin-bottom: 2rem; font-size: 0.9rem; }
    .btn {
      display: inline-block;
      padding: 14px 32px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: background 0.2s;
    }
    .btn:hover { background: #ff5252; }
    .btn:disabled { background: #444; cursor: not-allowed; }
    .status {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      display: none;
    }
    .status.error { display: block; background: #2d1515; color: #ff6b6b; border: 1px solid #ff6b6b33; }
    .status.success { display: block; background: #152d15; color: #6bff6b; border: 1px solid #6bff6b33; }
    .status.info { display: block; background: #15152d; color: #6b6bff; border: 1px solid #6b6bff33; }
    .step { margin-top: 1rem; color: #888; font-size: 0.85rem; }
    .address { font-family: monospace; font-size: 0.8rem; word-break: break-all; margin-top: 0.5rem; color: #aaa; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ðŸ¦ž</div>
    <h1>$CLAWD Token Gate</h1>
    <p class="subtitle">Connect your wallet and verify you hold at least 10M $CLAWD (~$500) on Base to join the chat</p>

    <button id="connectBtn" class="btn" onclick="connect()">Connect Wallet</button>

    <div id="status" class="status"></div>
    <div id="steps" class="step"></div>
  </div>

  <script>
    // Detect in-app browsers â€” be aggressive, check for NO wallet too
    function isInAppBrowser() {
      const ua = navigator.userAgent || '';
      // Explicit in-app browser UAs
      if (/Telegram|TelegramBot|Twitter|FBAN|FBAV|Instagram|Line\/|Snapchat|Discord/i.test(ua)) return true;
      // Generic WebView detection
      if (/WebView|wv\)/i.test(ua)) return true;
      // iOS: Telegram doesn't always set its UA, but it IS a WKWebView without Safari
      // Real Safari has "Safari/" in UA. In-app WKWebViews typically don't.
      if (/iPhone|iPad|iPod/i.test(ua) && !/Safari\//i.test(ua)) return true;
      return false;
    }

    function shouldEject() {
      // Eject if in-app browser OR no wallet available
      return isInAppBrowser() || !window.ethereum;
    }

    function ejectToSystemBrowser() {
      const url = window.location.href;
      const container = document.querySelector('.container');

      // Try auto-open in system browser first
      // On iOS: window.open with _blank sometimes breaks out of in-app browser
      // On Android: intent:// for Chrome
      const isAndroid = /android/i.test(navigator.userAgent);
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

      container.innerHTML = `
        <div class="logo">ðŸ¦ž</div>
        <h1>Open in Your Browser</h1>
        <p class="subtitle">This page needs a wallet (like MetaMask) to verify your $CLAWD tokens. Open it in ${isIOS ? 'Safari' : 'Chrome'} or your wallet app's browser.</p>
        <a href="${url}" target="_blank" rel="noopener"
          class="btn" style="display:block; text-decoration:none; margin-bottom: 1rem;"
          onclick="trySystemOpen(event)">
          ðŸ”— Open in ${isIOS ? 'Safari' : 'Browser'}
        </a>
        <button class="btn" style="background: #333;" onclick="copyUrl()">ðŸ“‹ Copy Link Instead</button>
        <div id="copyConfirm" class="step" style="margin-top: 0.5rem;"></div>
        <div id="status" class="status"></div>
      `;

      // On Android, try intent immediately
      if (isAndroid) {
        try {
          const intentUrl = 'intent://' + url.replace(/^https?:\/\//, '') +
            '#Intent;scheme=https;package=com.android.chrome;end';
          window.location.href = intentUrl;
        } catch(e) {}
      }
    }

    function trySystemOpen(e) {
      // For iOS Telegram: try opening via a blank anchor with target=_blank
      // The <a> tag already has target="_blank" so the default action may work
      // If not, also try window.open
      try { window.open(window.location.href, '_system'); } catch(ex) {}
    }

    function copyUrl() {
      const url = window.location.href;
      navigator.clipboard.writeText(url).then(() => {
        document.getElementById('copyConfirm').textContent = 'âœ… Copied! Paste in Safari or Chrome.';
      }).catch(() => {
        // Fallback: prompt
        prompt('Copy this link:', url);
      });
    }

    // Check on load â€” eject if in-app OR no wallet
    if (shouldEject()) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ejectToSystemBrowser);
      } else {
        ejectToSystemBrowser();
      }
    }

    const params = new URLSearchParams(window.location.search);
    const telegramUserId = params.get('tg');
    const chatId = params.get('chat');

    if (!telegramUserId || !chatId) {
      showStatus('error', 'Missing verification parameters. Use the link from the Telegram bot.');
    }

    let provider = null;
    let signer = null;
    let address = null;

    function showStatus(type, msg) {
      const el = document.getElementById('status');
      el.className = 'status ' + type;
      el.textContent = msg;
    }

    function showStep(msg) {
      document.getElementById('steps').textContent = msg;
    }

    async function connect() {
      const btn = document.getElementById('connectBtn');

      if (!window.ethereum) {
        showStatus('error', 'No wallet detected. Install MetaMask or use a Web3 browser.');
        return;
      }

      try {
        btn.disabled = true;
        btn.textContent = 'Connecting...';
        showStep('Step 1/3: Connecting wallet...');

        // Request accounts
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        address = accounts[0];
        showStep('Step 2/3: Getting nonce...');

        // Get nonce from server
        const nonceRes = await fetch(`/api/nonce?tg=${telegramUserId}&chat=${chatId}`);
        const { nonce } = await nonceRes.json();

        // Build SIWE message
        const domain = window.location.host;
        const origin = window.location.origin;
        const statement = `Verify $CLAWD token ownership for Telegram user ${telegramUserId}`;

        const siweMessage = [
          `${domain} wants you to sign in with your Ethereum account:`,
          address,
          '',
          statement,
          '',
          `URI: ${origin}`,
          `Version: 1`,
          `Chain ID: 8453`,
          `Nonce: ${nonce}`,
          `Issued At: ${new Date().toISOString()}`,
        ].join('\n');

        showStep('Step 3/3: Sign the message in your wallet...');

        // Request signature
        const signature = await window.ethereum.request({
          method: 'personal_sign',
          params: [siweMessage, address],
        });

        showStep('Verifying...');

        // Send to server
        const verifyRes = await fetch('/api/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: siweMessage, signature }),
        });

        const result = await verifyRes.json();

        if (result.success) {
          showStatus('success', 'âœ… Verified! Check your Telegram DMs from @ClawdBouncerBot â€” your invite link is there! ðŸ¦ž');
          btn.textContent = 'Verified âœ…';
          showStep('');
        } else {
          showStatus('error', result.error || 'Verification failed');
          btn.disabled = false;
          btn.textContent = 'Try Again';
          showStep('');
        }
      } catch (err) {
        console.error(err);
        showStatus('error', err.message || 'Something went wrong');
        btn.disabled = false;
        btn.textContent = 'Try Again';
        showStep('');
      }
    }
  </script>
</body>
</html>
